/***********************************************************************
 *   ___  ___  ___  ___  ___  ___   _    ___  _ _ _ 
 *  | . || __>|_ _|| __>| . \/  _> | |  | . || | | |
 *  |   || _>  | | | _> |   /| <_/\| |_ | | || | | |
 *  |_|_||_|   |_| |___>|_\_\`____/|___|`___'|__/_/ 
 *                                                 rp2040
 *      Copyright (c) 2024 bitfield labs
 *
 ***********************************************************************
 *  This file is part of the afterglow pinball LED project:
 *  https://github.com/bitfieldlabs/afterglow
 *
 *  afterglow is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as
 *  published by the Free Software Foundation, either version 3 of the
 *  License, or (at your option) any later version.
 *
 *  afterglow is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public
 *  License along with afterglow.
 *  If not, see <http://www.gnu.org/licenses/>.
 ***********************************************************************/

#include <string.h>
#include "display.h"
#include "pico/stdlib.h"
#include "pico/time.h"
#include "ssd1306.h"

#if DEBUG_OLED_I2C

#include "hardware/i2c.h"
#include "def.h"
#include "pindef.h"
#include "afterglow.h"
#include "config.h"
#include "record.h"
#include "smart.h"


//------------------------------------------------------------------------------
// local definitions

// Display update interval [us]
#define DISPLAY_UPDATE_INT (200000)


// bitfield labs logo
const unsigned long bfl_logo_size=1170;
unsigned char bfl_logo_data[]={
    0x42,0x4d,0x92,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x92,0x00,0x00,0x00,0x7c,0x00,
    0x00,0x00,0x80,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,
    0x00,0x00,0x00,0x04,0x00,0x00,0x27,0x2e,0x00,0x00,0x27,0x2e,0x00,0x00,0x02,0x00,
    0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0xff,0x00,0x00,0xff,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x42,0x47,0x52,0x73,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,
    0xff,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0x00,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xfc,0x00,0x0f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xf8,0x00,0x07,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xf0,0x00,0x03,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xe0,0x00,0x03,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xc0,0x00,0x01,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0x80,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0x80,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0x00,0x00,0x00,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0x30,0x03,0x00,0x7c,0x07,0x8c,0x27,0xe7,0x07,0xc2,0x0f,0xfc,0x38,0x0f,
    0x07,0x03,0x30,0x1b,0x80,0x7c,0x03,0x08,0x27,0xc6,0x01,0x80,0x03,0xf8,0x30,0x0e,
    0x03,0x01,0x34,0x1f,0xa0,0x7c,0xf1,0x19,0xe7,0xcc,0x39,0x0c,0x63,0xf0,0xe1,0x8c,
    0x61,0xf0,0x3d,0xdf,0xe8,0x7c,0xf1,0x19,0xe7,0xcc,0x0d,0x0c,0x63,0xf0,0xe3,0x8c,
    0x71,0xf0,0x3d,0xff,0xfc,0x7c,0xf1,0x19,0xe1,0xcc,0x07,0x1c,0xf3,0xf1,0xe3,0xcc,
    0xf1,0x80,0x3f,0xbf,0xfc,0x7c,0x61,0x19,0xe1,0xcc,0x67,0x1c,0xf3,0xf1,0xe3,0xcc,
    0xf1,0x81,0x3f,0xbf,0xfe,0x7c,0x03,0x18,0xe1,0xcc,0x23,0x1c,0x63,0xf1,0xe1,0x8c,
    0x61,0x0f,0x3f,0x3f,0xfe,0x7c,0x07,0x18,0x27,0xce,0x03,0x1c,0x03,0xf1,0xf0,0x1c,
    0x03,0x01,0x9f,0x3c,0x7c,0xfc,0x47,0xf8,0x23,0xff,0x87,0x1f,0x13,0xf1,0xf8,0x3c,
    0x8f,0x81,0x9f,0xbd,0x7c,0xfc,0x07,0x19,0xf0,0x4f,0xff,0x1f,0xf3,0xf1,0xff,0xfc,
    0xff,0xff,0xcf,0xfd,0x79,0xfe,0x0f,0x19,0xf8,0x4f,0xff,0x1f,0xf3,0xf1,0xff,0xfc,
    0xff,0xff,0xc7,0xfc,0x71,0xfe,0x0f,0xb9,0xf8,0xcf,0xff,0x3f,0xf3,0xf3,0xff,0xfc,
    0xff,0xff,0xf3,0xff,0xf3,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xf8,0x7f,0xf9,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,
    0x07,0xff,0xfc,0x07,0xf9,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xc0,
    0x01,0xff,0xff,0x07,0xfc,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x81,
    0x80,0x7f,0xff,0xfb,0xee,0x0f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x07,
    0xe0,0x7f,0xff,0xfc,0xef,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x07,
    0xf0,0x3f,0xff,0xfc,0xcf,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x07,
    0xf0,0x3f,0xff,0xfc,0x6f,0x9f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x87,
    0xf8,0x1f,0xff,0xfe,0x7c,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xef,
    0xf8,0x1f,0xff,0xfc,0xf0,0x7f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xf0,0x3f,0xff,0xfc,0xc3,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xe0,0x3f,0xff,0xfc,0xc6,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,
    0x00,0x7f,0xff,0xfe,0x3e,0xbf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfe,
    0x00,0xff,0xff,0xff,0xfe,0xbf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0x00,0x7f,0xff,0xff,0xfe,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xf0,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe1,
    0xf8,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,
    0xf8,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,
    0xfc,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xe0,
    0xf8,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf0,
    0x70,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xf8,
    0x00,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xfc,
    0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xcf,0xff,0x0f,0xc3,0x1f,0xfc,0x3f,0x00,0x71,0xf0,0xf0,0x07,0x80,0x3c,0x07,0xf8,
    0x78,0x7f,0x8f,0xc7,0x1f,0xfc,0x3f,0x00,0x71,0xe1,0xe0,0x07,0x80,0x38,0x01,0xf8,
    0x78,0x3f,0x8f,0x87,0x1f,0xfc,0x3f,0x00,0x71,0xc3,0xc1,0xc7,0x80,0x30,0xe1,0xf0,
    0x38,0x3f,0xc0,0x0f,0x1f,0xfc,0x3f,0x1f,0xf1,0xc3,0x87,0xc7,0x8f,0xe1,0xf0,0xf0,
    0x38,0x3f,0xc0,0x0f,0x1f,0xfc,0x3f,0x1f,0xf1,0x87,0x87,0xc7,0x8f,0xe1,0xf8,0xf0,
    0x30,0x3f,0xc7,0x0f,0x1f,0xfc,0x3f,0x1f,0xf0,0x0f,0x8e,0x07,0x8f,0xe3,0xf8,0xf1,
    0x31,0x1f,0xe3,0x1f,0x00,0x7c,0x3f,0x00,0x70,0x07,0x8e,0x07,0x8f,0xe3,0xf8,0xe1,
    0x11,0x1f,0xe3,0x1f,0x00,0x7c,0x3f,0x00,0x71,0xc3,0x8f,0xff,0x8f,0xe3,0xf8,0xe3,
    0x03,0x1f,0xe0,0x1f,0x1f,0xfc,0x3f,0x1f,0xf1,0xe3,0x87,0xff,0x8f,0xe1,0xf8,0xe3,
    0x03,0x1f,0xf0,0x3f,0x1f,0xfc,0x3f,0x1f,0xf1,0xe1,0x87,0xf7,0x8f,0xe1,0xf0,0xe3,
    0x83,0x0f,0xf0,0x3f,0x1f,0xfc,0x3f,0x1f,0xf1,0xc3,0xc1,0xe7,0x8f,0xf0,0xe1,0xc3,
    0x83,0x8f,0xf0,0x3f,0x00,0x40,0x03,0x00,0x70,0x03,0xe0,0x07,0x8f,0xf8,0x01,0xc7,
    0x87,0x8f,0xf8,0x7f,0x00,0x40,0x03,0x00,0x70,0x07,0xf0,0x0f,0x8f,0xfc,0x07,0xc7,
    0x87,0x87,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
    0xff,0xff
};

const uint8_t font_small_8x5[] =
{
			8, 5, 1, 32, 126,
			0x00, 0x00, 0x00, 0x00, 0x00,
			0x00, 0x00, 0x5F, 0x00, 0x00,
			0x00, 0x07, 0x00, 0x07, 0x00,
			0x14, 0x7F, 0x14, 0x7F, 0x14,
			0x24, 0x2A, 0x7F, 0x2A, 0x12,
			0x23, 0x13, 0x08, 0x64, 0x62,
			0x36, 0x49, 0x56, 0x20, 0x50,
			0x00, 0x08, 0x07, 0x03, 0x00,
			0x00, 0x1C, 0x22, 0x41, 0x00,
			0x00, 0x41, 0x22, 0x1C, 0x00,
			0x2A, 0x1C, 0x7F, 0x1C, 0x2A,
			0x08, 0x08, 0x3E, 0x08, 0x08,
			0x00, 0x80, 0x70, 0x30, 0x00,
			0x08, 0x08, 0x08, 0x08, 0x08,
			0x00, 0x00, 0x60, 0x60, 0x00,
			0x20, 0x10, 0x08, 0x04, 0x02,
			0x3E, 0x51, 0x49, 0x45, 0x3E,
			0x00, 0x42, 0x7F, 0x40, 0x00,
			0x72, 0x49, 0x49, 0x49, 0x46,
			0x21, 0x41, 0x49, 0x4D, 0x33,
			0x18, 0x14, 0x12, 0x7F, 0x10,
			0x27, 0x45, 0x45, 0x45, 0x39,
			0x3C, 0x4A, 0x49, 0x49, 0x31,
			0x41, 0x21, 0x11, 0x09, 0x07,
			0x36, 0x49, 0x49, 0x49, 0x36,
			0x46, 0x49, 0x49, 0x29, 0x1E,
			0x00, 0x00, 0x14, 0x00, 0x00,
			0x00, 0x40, 0x34, 0x00, 0x00,
			0x00, 0x08, 0x14, 0x22, 0x41,
			0x14, 0x14, 0x14, 0x14, 0x14,
			0x00, 0x41, 0x22, 0x14, 0x08,
			0x02, 0x01, 0x59, 0x09, 0x06,
			0x3E, 0x41, 0x5D, 0x59, 0x4E,
			0x7C, 0x12, 0x11, 0x12, 0x7C,
			0x7F, 0x49, 0x49, 0x49, 0x36,
			0x3E, 0x41, 0x41, 0x41, 0x22,
			0x7F, 0x41, 0x41, 0x41, 0x3E,
			0x7F, 0x49, 0x49, 0x49, 0x41,
			0x7F, 0x09, 0x09, 0x09, 0x01,
			0x3E, 0x41, 0x41, 0x51, 0x73,
			0x7F, 0x08, 0x08, 0x08, 0x7F,
			0x00, 0x41, 0x7F, 0x41, 0x00,
			0x20, 0x40, 0x41, 0x3F, 0x01,
			0x7F, 0x08, 0x14, 0x22, 0x41,
			0x7F, 0x40, 0x40, 0x40, 0x40,
			0x7F, 0x02, 0x1C, 0x02, 0x7F,
			0x7F, 0x04, 0x08, 0x10, 0x7F,
			0x3E, 0x41, 0x41, 0x41, 0x3E,
			0x7F, 0x09, 0x09, 0x09, 0x06,
			0x3E, 0x41, 0x51, 0x21, 0x5E,
			0x7F, 0x09, 0x19, 0x29, 0x46,
			0x26, 0x49, 0x49, 0x49, 0x32,
			0x03, 0x01, 0x7F, 0x01, 0x03,
			0x3F, 0x40, 0x40, 0x40, 0x3F,
			0x1F, 0x20, 0x40, 0x20, 0x1F,
			0x3F, 0x40, 0x38, 0x40, 0x3F,
			0x63, 0x14, 0x08, 0x14, 0x63,
			0x03, 0x04, 0x78, 0x04, 0x03,
			0x61, 0x59, 0x49, 0x4D, 0x43,
			0x00, 0x7F, 0x41, 0x41, 0x41,
			0x02, 0x04, 0x08, 0x10, 0x20,
			0x00, 0x41, 0x41, 0x41, 0x7F,
			0x04, 0x02, 0x01, 0x02, 0x04,
			0x40, 0x40, 0x40, 0x40, 0x40,
			0x00, 0x03, 0x07, 0x08, 0x00,
			0x20, 0x54, 0x54, 0x78, 0x40,
			0x7F, 0x28, 0x44, 0x44, 0x38,
			0x38, 0x44, 0x44, 0x44, 0x28,
			0x38, 0x44, 0x44, 0x28, 0x7F,
			0x38, 0x54, 0x54, 0x54, 0x18,
			0x00, 0x08, 0x7E, 0x09, 0x02,
			0x18, 0xA4, 0xA4, 0x9C, 0x78,
			0x7F, 0x08, 0x04, 0x04, 0x78,
			0x00, 0x44, 0x7D, 0x40, 0x00,
			0x20, 0x40, 0x40, 0x3D, 0x00,
			0x7F, 0x10, 0x28, 0x44, 0x00,
			0x00, 0x41, 0x7F, 0x40, 0x00,
			0x7C, 0x04, 0x78, 0x04, 0x78,
			0x7C, 0x08, 0x04, 0x04, 0x78,
			0x38, 0x44, 0x44, 0x44, 0x38,
			0xFC, 0x18, 0x24, 0x24, 0x18,
			0x18, 0x24, 0x24, 0x18, 0xFC,
			0x7C, 0x08, 0x04, 0x04, 0x08,
			0x48, 0x54, 0x54, 0x54, 0x24,
			0x04, 0x04, 0x3F, 0x44, 0x24,
			0x3C, 0x40, 0x40, 0x20, 0x7C,
			0x1C, 0x20, 0x40, 0x20, 0x1C,
			0x3C, 0x40, 0x30, 0x40, 0x3C,
			0x44, 0x28, 0x10, 0x28, 0x44,
			0x4C, 0x90, 0x90, 0x90, 0x7C,
			0x44, 0x64, 0x54, 0x4C, 0x44,
			0x00, 0x08, 0x36, 0x41, 0x00,
			0x00, 0x00, 0x77, 0x00, 0x00,
			0x00, 0x41, 0x36, 0x08, 0x00,
			0x02, 0x01, 0x02, 0x04, 0x02,
};

const uint8_t acme_font[] = {
	8, 6, 1, 32, 126,
	0x00,0x00,0x00,0x00,0x00,0x00, //  
	0x7f,0x51,0x7f,0x00,0x00,0x00, // !
	0x0f,0x09,0x0f,0x09,0x0f,0x00, // "
	0x3e,0x6b,0x41,0x6b,0x41,0x6b, // #
	0x7f,0xd1,0x94,0xc5,0x7f,0x00, // $
	0x77,0x4d,0x77,0x59,0x77,0x00, // %
	0x7f,0x49,0x55,0x49,0x6f,0x54, // &
	0x0f,0x09,0x0f,0x00,0x00,0x00, // '
	0x7f,0xc1,0xbe,0xe3,0x00,0x00, // (
	0xe3,0xbe,0xc1,0x7f,0x00,0x00, // )
	0x3e,0x2a,0x77,0x41,0x77,0x2a, // *
	0x1c,0x14,0x77,0x41,0x77,0x14, // +
	0xe0,0xb0,0xd0,0x70,0x00,0x00, // ,
	0x1c,0x14,0x14,0x14,0x1c,0x00, // -
	0x70,0x50,0x70,0x00,0x00,0x00, // .
	0x78,0x4c,0x77,0x19,0x0f,0x00, // /
	0x7f,0x41,0x5d,0x41,0x7f,0x00, // 0
	0x7f,0x41,0x7f,0x00,0x00,0x00, // 1
	0x7f,0x45,0x55,0x51,0x7f,0x00, // 2
	0x7f,0x55,0x55,0x41,0x7f,0x00, // 3
	0x1f,0x11,0x77,0x41,0x7f,0x00, // 4
	0x7f,0x51,0x55,0x45,0x7f,0x00, // 5
	0x7f,0x41,0x55,0x45,0x7f,0x00, // 6
	0x07,0x7d,0x45,0x79,0x0f,0x00, // 7
	0x7f,0x49,0x55,0x49,0x7f,0x00, // 8
	0x7f,0x51,0x55,0x41,0x7f,0x00, // 9
	0x3e,0x2a,0x3e,0x00,0x00,0x00, // :
	0xe0,0xbe,0xda,0x7e,0x00,0x00, // ;
	0x1c,0x36,0x6b,0x5d,0x77,0x00, // <
	0x3e,0x2a,0x2a,0x2a,0x2a,0x3e, // =
	0x77,0x5d,0x6b,0x36,0x1c,0x00, // >
	0x07,0x7d,0x55,0x71,0x1f,0x00, // ?
	0x7f,0x41,0x5d,0x55,0x51,0x7f, // @
	0x7f,0x41,0x75,0x41,0x7f,0x00, // A
	0x7f,0x41,0x55,0x41,0x7f,0x00, // B
	0x7f,0x41,0x5d,0x55,0x77,0x00, // C
	0x7f,0x41,0x5d,0x63,0x3e,0x00, // D
	0x7f,0x41,0x55,0x55,0x7f,0x00, // E
	0x7f,0x41,0x75,0x15,0x1f,0x00, // F
	0x7f,0x41,0x5d,0x45,0x7f,0x00, // G
	0x7f,0x41,0x77,0x41,0x7f,0x00, // H
	0x7f,0x41,0x7f,0x00,0x00,0x00, // I
	0x78,0x48,0x5f,0x41,0x7f,0x00, // J
	0x7f,0x41,0x77,0x49,0x7f,0x00, // K
	0x7f,0x41,0x5f,0x50,0x70,0x00, // L
	0x7f,0x41,0x3b,0x3b,0x41,0x7f, // M
	0x7f,0x41,0x3b,0x76,0x41,0x7f, // N
	0x7f,0x41,0x5d,0x41,0x7f,0x00, // O
	0x7f,0x41,0x75,0x11,0x1f,0x00, // P
	0x7f,0x41,0x1d,0x41,0x7f,0x00, // Q
	0x7f,0x41,0x6d,0x51,0x6f,0x00, // R
	0x7f,0x51,0x55,0x45,0x7f,0x00, // S
	0x07,0x7d,0x41,0x7d,0x07,0x00, // T
	0x7f,0x41,0x5f,0x41,0x7f,0x00, // U
	0x3f,0x61,0x5f,0x61,0x3f,0x00, // V
	0x7f,0x41,0x6e,0x6e,0x41,0x7f, // W
	0x7f,0x49,0x77,0x49,0x7f,0x00, // X
	0x1f,0x71,0x47,0x71,0x1f,0x00, // Y
	0x7b,0x4d,0x55,0x59,0x6f,0x00, // Z
	0xff,0x80,0xbe,0xe3,0x00,0x00, // [
	0x0f,0x19,0x77,0x4c,0x78,0x00, // "\"
	0xe3,0xbe,0x80,0xff,0x00,0x00, // ]
	0x0e,0x0b,0x0d,0x0b,0x0e,0x00, // ^
	0xe0,0xa0,0xa0,0xa0,0xa0,0xe0, // _
	0x07,0x0d,0x0b,0x0e,0x00,0x00, // `
	0x7f,0x41,0x75,0x41,0x7f,0x00, // a
	0x7f,0x41,0x55,0x41,0x7f,0x00, // b
	0x7f,0x41,0x5d,0x55,0x77,0x00, // c
	0x7f,0x41,0x5d,0x63,0x3e,0x00, // d
	0x7f,0x41,0x55,0x55,0x7f,0x00, // e
	0x7f,0x41,0x75,0x15,0x1f,0x00, // f
	0x7f,0x41,0x5d,0x45,0x7f,0x00, // g
	0x7f,0x41,0x77,0x41,0x7f,0x00, // h
	0x7f,0x41,0x7f,0x00,0x00,0x00, // i
	0x78,0x48,0x5f,0x41,0x7f,0x00, // j
	0x7f,0x41,0x77,0x49,0x7f,0x00, // k
	0x7f,0x41,0x5f,0x50,0x70,0x00, // l
	0x7f,0x41,0x3b,0x3b,0x41,0x7f, // m
	0x7f,0x41,0x3b,0x76,0x41,0x7f, // n
	0x7f,0x41,0x5d,0x41,0x7f,0x00, // o
	0x7f,0x41,0x75,0x11,0x1f,0x00, // p
	0x7f,0x41,0x1d,0x41,0x7f,0x00, // q
	0x7f,0x41,0x6d,0x51,0x6f,0x00, // r
	0x7f,0x51,0x55,0x45,0x7f,0x00, // s
	0x07,0x7d,0x41,0x7d,0x07,0x00, // t
	0x7f,0x41,0x5f,0x41,0x7f,0x00, // u
	0x3f,0x61,0x5f,0x61,0x3f,0x00, // v
	0x7f,0x41,0x6e,0x6e,0x41,0x7f, // w
	0x7f,0x49,0x77,0x49,0x7f,0x00, // x
	0x1f,0x71,0x47,0x71,0x1f,0x00, // y
	0x7b,0x4d,0x55,0x59,0x6f,0x00, // z
	0x1c,0xf7,0x88,0xbe,0xe3,0x00, // {
	0xff,0x80,0xff,0x00,0x00,0x00, // |
	0xe3,0xbe,0x88,0xf7,0x1c,0x00, // }
	0x0f,0x09,0x0d,0x09,0x0b,0x09, // ~
	0x00,0x00,0x00,0x00,0x00,0x00
};

const uint8_t BMSPA_font[] = {
	8, 8, 0, 32, 126,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //  
	0x00,0x5f,0x00,0x00,0x00,0x00,0x00,0x00, // !
	0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00, // "
	0x0a,0x1f,0x0a,0x1f,0x0a,0x00,0x00,0x00, // #
	0x24,0x2a,0x2a,0x7f,0x2a,0x2a,0x12,0x00, // $
	0x00,0x47,0x25,0x17,0x08,0x74,0x52,0x71, // %
	0x00,0x36,0x49,0x49,0x49,0x41,0x41,0x38, // &
	0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00, // '
	0x00,0x3e,0x41,0x00,0x00,0x00,0x00,0x00, // (
	0x41,0x3e,0x00,0x00,0x00,0x00,0x00,0x00, // )
	0x04,0x15,0x0e,0x15,0x04,0x00,0x00,0x00, // *
	0x08,0x08,0x3e,0x08,0x08,0x00,0x00,0x00, // +
	0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00, // ,
	0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00, // -
	0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // .
	0x40,0x20,0x10,0x08,0x04,0x02,0x01,0x00, // /
	0x00,0x3e,0x61,0x51,0x49,0x45,0x43,0x3e, // 0
	0x01,0x01,0x7e,0x00,0x00,0x00,0x00,0x00, // 1
	0x00,0x71,0x49,0x49,0x49,0x49,0x49,0x46, // 2
	0x41,0x49,0x49,0x49,0x49,0x49,0x36,0x00, // 3
	0x00,0x0f,0x10,0x10,0x10,0x10,0x10,0x7f, // 4
	0x00,0x4f,0x49,0x49,0x49,0x49,0x49,0x31, // 5
	0x00,0x3e,0x49,0x49,0x49,0x49,0x49,0x30, // 6
	0x01,0x01,0x01,0x01,0x01,0x01,0x7e,0x00, // 7
	0x00,0x36,0x49,0x49,0x49,0x49,0x49,0x36, // 8
	0x00,0x06,0x49,0x49,0x49,0x49,0x49,0x3e, // 9
	0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // :
	0x40,0x34,0x00,0x00,0x00,0x00,0x00,0x00, // ;
	0x08,0x14,0x22,0x00,0x00,0x00,0x00,0x00, // <
	0x14,0x14,0x14,0x14,0x14,0x00,0x00,0x00, // =
	0x22,0x14,0x08,0x00,0x00,0x00,0x00,0x00, // >
	0x00,0x06,0x01,0x01,0x59,0x09,0x09,0x06, // ?
	0x00,0x3e,0x41,0x5d,0x55,0x5d,0x51,0x5e, // @
	0x00,0x7e,0x01,0x09,0x09,0x09,0x09,0x7e, // A
	0x00,0x7f,0x41,0x49,0x49,0x49,0x49,0x36, // B
	0x00,0x3e,0x41,0x41,0x41,0x41,0x41,0x22, // C
	0x00,0x7f,0x41,0x41,0x41,0x41,0x41,0x3e, // D
	0x00,0x3e,0x49,0x49,0x49,0x49,0x49,0x41, // E
	0x00,0x7e,0x09,0x09,0x09,0x09,0x09,0x01, // F
	0x00,0x3e,0x41,0x49,0x49,0x49,0x49,0x79, // G
	0x00,0x7f,0x08,0x08,0x08,0x08,0x08,0x7f, // H
	0x00,0x7f,0x00,0x00,0x00,0x00,0x00,0x00, // I
	0x00,0x38,0x40,0x40,0x41,0x41,0x41,0x3f, // J
	0x00,0x7f,0x08,0x08,0x08,0x0c,0x0a,0x71, // K
	0x00,0x3f,0x40,0x40,0x40,0x40,0x40,0x40, // L
	0x00,0x7e,0x01,0x01,0x7e,0x01,0x01,0x7e, // M
	0x00,0x7e,0x01,0x01,0x3e,0x40,0x40,0x3f, // N
	0x00,0x3e,0x41,0x41,0x41,0x41,0x41,0x3e, // O
	0x00,0x7e,0x09,0x09,0x09,0x09,0x09,0x06, // P
	0x00,0x3e,0x41,0x41,0x71,0x51,0x51,0x7e, // Q
	0x00,0x7e,0x01,0x31,0x49,0x49,0x49,0x46, // R
	0x00,0x46,0x49,0x49,0x49,0x49,0x49,0x31, // S
	0x01,0x01,0x01,0x7f,0x01,0x01,0x01,0x00, // T
	0x00,0x3f,0x40,0x40,0x40,0x40,0x40,0x3f, // U
	0x00,0x0f,0x10,0x20,0x40,0x20,0x10,0x0f, // V
	0x00,0x3f,0x40,0x40,0x3f,0x40,0x40,0x3f, // W
	0x00,0x63,0x14,0x08,0x08,0x08,0x14,0x63, // X
	0x00,0x07,0x08,0x08,0x78,0x08,0x08,0x07, // Y
	0x00,0x71,0x49,0x49,0x49,0x49,0x49,0x47, // Z
	0x00,0x7f,0x41,0x00,0x00,0x00,0x00,0x00, // [
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // "\"
	0x41,0x7f,0x00,0x00,0x00,0x00,0x00,0x00, // ]
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // ^
	0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00, // _
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // `
	0x00,0x7e,0x01,0x09,0x09,0x09,0x09,0x7e, // A
	0x00,0x7f,0x41,0x49,0x49,0x49,0x49,0x36, // B
	0x00,0x3e,0x41,0x41,0x41,0x41,0x41,0x22, // C
	0x00,0x7f,0x41,0x41,0x41,0x41,0x41,0x3e, // D
	0x00,0x3e,0x49,0x49,0x49,0x49,0x49,0x41, // E
	0x00,0x7e,0x09,0x09,0x09,0x09,0x09,0x01, // F
	0x00,0x3e,0x41,0x49,0x49,0x49,0x49,0x79, // G
	0x00,0x7f,0x08,0x08,0x08,0x08,0x08,0x7f, // H
	0x00,0x7f,0x00,0x00,0x00,0x00,0x00,0x00, // I
	0x00,0x38,0x40,0x40,0x41,0x41,0x41,0x3f, // J
	0x00,0x7f,0x08,0x08,0x08,0x0c,0x0a,0x71, // K
	0x00,0x3f,0x40,0x40,0x40,0x40,0x40,0x40, // L
	0x00,0x7e,0x01,0x01,0x7e,0x01,0x01,0x7e, // M
	0x00,0x7e,0x01,0x01,0x3e,0x40,0x40,0x3f, // N
	0x00,0x3e,0x41,0x41,0x41,0x41,0x41,0x3e, // O
	0x00,0x7e,0x09,0x09,0x09,0x09,0x09,0x06, // P
	0x00,0x3e,0x41,0x41,0x71,0x51,0x51,0x7e, // Q
	0x00,0x7e,0x01,0x31,0x49,0x49,0x49,0x46, // R
	0x00,0x46,0x49,0x49,0x49,0x49,0x49,0x31, // S
	0x01,0x01,0x01,0x7f,0x01,0x01,0x01,0x00, // T
	0x00,0x3f,0x40,0x40,0x40,0x40,0x40,0x3f, // U
	0x00,0x0f,0x10,0x20,0x40,0x20,0x10,0x0f, // V
	0x00,0x3f,0x40,0x40,0x3f,0x40,0x40,0x3f, // W
	0x00,0x63,0x14,0x08,0x08,0x08,0x14,0x63, // X
	0x00,0x07,0x08,0x08,0x78,0x08,0x08,0x07, // Y
	0x00,0x71,0x49,0x49,0x49,0x49,0x49,0x47, // Z
	0x08,0x36,0x41,0x00,0x00,0x00,0x00,0x00, // {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // |
	0x41,0x36,0x08,0x00,0x00,0x00,0x00,0x00, // }
	0x02,0x01,0x01,0x02,0x02,0x01,0x00,0x00, // ~
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

//------------------------------------------------------------------------------
// local variables

ssd1306_t sDisp;
bool sDispInit = false;
DISPLAY_MODES_t sMainMode = DISPLAY_MODE_LOGO;
uint64_t sLastUpdate = 0;
char sNotice1[64] = "\0";
char sNotice2[64] = "\0";
char sNotice3[64] = "\0";
uint64_t sNoticeStartTime = 0;
uint32_t sNoticeDuration = 0;


//------------------------------------------------------------------------------
void display_setMode(DISPLAY_MODES_t mode)
{
    sMainMode = mode;
}

//------------------------------------------------------------------------------
void display_setNotice(const char *pkStr1, const char *pkStr2, const char *pkStr3, uint32_t duration)
{
    strncpy(sNotice1, pkStr1, 64);
    strncpy(sNotice2, pkStr2, 64);
    strncpy(sNotice3, pkStr3, 64);
    sNoticeStartTime = to_us_since_boot(get_absolute_time());
    sNoticeDuration = duration;
}

//------------------------------------------------------------------------------
bool display_init()
{
    i2c_init(i2c0, 1000000);
    gpio_set_function(AGPIN_D_SDA, GPIO_FUNC_I2C);
    gpio_set_function(AGPIN_D_SCL, GPIO_FUNC_I2C);
    gpio_pull_up(AGPIN_D_SDA);
    gpio_pull_up(AGPIN_D_SCL);

    // check if display is present
    uint8_t addr = 0x3C;
    if (i2c_write_timeout_us(i2c0, addr, &addr, 1, true, 100) == 1)
    {
        sDisp.external_vcc=false;
        sDispInit = ssd1306_init(&sDisp, 128, 64, addr, i2c0);
        if (sDispInit)
        {
            ssd1306_clear(&sDisp);
            ssd1306_bmp_show_image(&sDisp, bfl_logo_data, bfl_logo_size);
            ssd1306_show(&sDisp);
        }
    }
    return sDispInit;
}

//------------------------------------------------------------------------------
static void display_status()
{
    // use the first 16 rows to display status information
    ssd1306_clear_square(&sDisp, 0, 0, 128, 16);

    // mode
    ssd1306_draw_string_with_font(&sDisp, 1,4,1, BMSPA_font,
        (ag_mode() == AG_MODE_WPC) ? "WPC" :
        (ag_mode() == AG_MODE_WHITESTAR) ? "WS" : "???");
    
    // DIP switch indicators
    AG_DIPSWITCH_t ds = cfg_dipSwitch();
    if (ds.testMode)
    {
        ssd1306_draw_string_with_font(&sDisp, 98, 4, 1, acme_font, "T");
    }
    if (ds.replayMode)
    {
        ssd1306_draw_string_with_font(&sDisp, 104, 4, 1, acme_font, "R");
    }
    if (ds.smartMode)
    {
        ssd1306_draw_string_with_font(&sDisp, 110, 4, 1, acme_font, "S");
    }
    if (ds.passThrough)
    {
        ssd1306_draw_string_with_font(&sDisp, 116, 4, 1, acme_font, "P");
    }

    // status
    AFTERGLOW_STATUS_t st = ag_status();
    const char * ag_st_str[] = {"INI", "OK ", "PTR", "TST", "REP", "REA", "REC", "INV" };
    if (st<8)
    {
        ssd1306_draw_string_with_font(&sDisp, 28, 4, 1, BMSPA_font, ag_st_str[st]);
    }
}

//------------------------------------------------------------------------------
void display_update()
{
    // nothing to do if no display
    if (!sDispInit)
    {
        return;
    }

    // keep track of time
    uint64_t ts = to_us_since_boot(get_absolute_time());

    // update the display at low rate only
    if ((ts - sLastUpdate) > DISPLAY_UPDATE_INT)
    {
        // choose a display mode
        if (ts > 3000000)
        {
            if (cfg_dipSwitch().smartMode && (ts < 8000000))
            {
                display_setMode(DISPLAY_MODE_LAMPTYPE);
            }
            else if (cfg_dipSwitch().replayMode)
            {
                if (cfg_dipSwitch().testMode && record_ready())
                {
                    display_setMode(DISPLAY_MODE_RECORDREADY);
                }
                else
                {
                    display_setMode(record_active() ? DISPLAY_MODE_RECORD : DISPLAY_MODE_REPLAY);
                }
            }
        }

        // check for active notice messages
        if ((sNoticeDuration > 0) && ((ts - sNoticeStartTime) < sNoticeDuration))
        {
            display_setMode(DISPLAY_MODE_NOTICE);
        }
        else
        {
            // notice done
            sNoticeDuration = 0;
        }
        
        // status header
        display_status();

        // main display
        switch (sMainMode)
        {
            // blank
            case DISPLAY_MODE_BLANK: ssd1306_clear_square(&sDisp, 0, 16, 128, 48); break;
            
            // logo (already loaded at start)
            case DISPLAY_MODE_LOGO: break;

            // replay mode
            case DISPLAY_MODE_REPLAY:
            {
                // clear
                ssd1306_clear_square(&sDisp, 0, 16, 128, 48);
                ssd1306_draw_string_with_font(&sDisp, 16, 20, 2, BMSPA_font, "Replay");
                uint32_t w = (98 * replay_percentage() / 100);
                ssd1306_draw_empty_square(&sDisp, 15, 49, 100, 6);
                ssd1306_draw_square(&sDisp, 16, 50, w, 4);
            }
            break;

            // record ready
            case DISPLAY_MODE_RECORDREADY:
            {
                // clear
                ssd1306_clear_square(&sDisp, 0, 16, 128, 48);
                ssd1306_draw_string_with_font(&sDisp, 16, 20, 2, BMSPA_font, "RECORD");
                ssd1306_draw_string_with_font(&sDisp, 16, 40, 2, BMSPA_font, "READY");
            }
            break;

            // record mode
            case DISPLAY_MODE_RECORD:
            {
                // clear
                ssd1306_clear_square(&sDisp, 0, 16, 128, 48);
                ssd1306_draw_string_with_font(&sDisp, 16, 20, 2, BMSPA_font, "RECORD");
                uint32_t w = (98 * record_percentage() / 100);
                ssd1306_draw_empty_square(&sDisp, 15, 49, 100, 6);
                ssd1306_draw_square(&sDisp, 16, 50, w, 4);
            }
            break;

            // notice
            case DISPLAY_MODE_NOTICE:
            {
                // clear
                ssd1306_clear_square(&sDisp, 0, 16, 128, 48);
                ssd1306_draw_string_with_font(&sDisp, 16, 20, 2, BMSPA_font, sNotice1);
                ssd1306_draw_string_with_font(&sDisp, 16, 36, 1, BMSPA_font, sNotice2);
                ssd1306_draw_string_with_font(&sDisp, 16, 52, 1, BMSPA_font, sNotice3);
            }
            break;

            // lamp types
            case DISPLAY_MODE_LAMPTYPE:
            {
                ssd1306_clear_square(&sDisp, 0, 16, 128, 48);
                ssd1306_draw_string_with_font(&sDisp, 1, 20, 1, font_small_8x5, "Smart lamps");
                ssd1306_draw_empty_square(&sDisp, 92, 18, 35, 44);
                uint32_t x = 94;
                for (uint32_t c = 0; c<NUM_COL; c++)
                {
                    uint32_t y = 20;
                    for (uint32_t r=0; r<NUM_ROW; r++)
                    {
                        switch (smart_lampType(c, r))
                        {

                            case LAMP_TYPE_TINYLED:
                            case LAMP_TYPE_LED:
                            {
                                ssd1306_draw_pixel(&sDisp, x+1, y+1);
                            }
                            break;
                            case LAMP_TYPE_INC:
                            {
                                ssd1306_draw_empty_square(&sDisp, x, y, 3, 3);
                            }
                            break;
                            case LAMP_TYPE_SHORT:
                            {
                                ssd1306_draw_square(&sDisp, x, y, 3, 3);
                            }
                            break;
                            default: break;
                        }
                        y += 4;
                    }
                    x += 4;
                }
            }
            break;

            default: break;
        }

        // send the update to the display
        ssd1306_show(&sDisp);

        sLastUpdate = ts;
    }
}

#endif // DEBUG_OLED_I2C
